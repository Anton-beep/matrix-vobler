user nginx;

worker_processes auto;

worker_rlimit_nofile 10240;

events {}

http {
    log_format client_received
        '$remote_addr - $remote_user [$time_local] '
        '"$request" '
        'status=$status '
        'bytes_sent=$body_bytes_sent '
        'content_type="$sent_http_content_type" '
        'referer="$http_referer" '
        'ua="$http_user_agent" '
        'upstream="$upstream_addr" '
        'upstream_status="$upstream_status"';

    access_log /var/log/nginx/access.log client_received;
  server {
      listen 4444 ssl;
      listen [::]:4444 ssl;

      ssl_certificate /etc/ssl/certs/fullchain.pem;
      ssl_certificate_key /etc/ssl/certs/privkey.pem;

      # For the federation port
      listen 8448 ssl default_server;
      listen [::]:8448 ssl default_server;

      server_name matrix.vobler-tech.space:4444;

      location /.well-known/matrix/server {
          default_type application/json;
          return 200 '{"m.server": "matrix.vobler-tech.space:8448"}';
      }

      location /.well-known/matrix/client {

          default_type application/json;
          add_header Access-Control-Allow-Origin *; # Required for web clients

          return 200 '{
              "m.homeserver": {
                  "base_url": "https://matrix.vobler-tech.space:4444"
              },
              "m.identity_server": {
                  "base_url": "https://vector.im"
              }
              "org.matrix.msc2965.authentication": {
                  "issuer": "https://matrix.vobler-tech.space:4444/",
                  "account": "https://matrix.vobler-tech.space:4444/account"
              }
          }';

      }

      location ~ ^/_matrix/client/(.+)/(login|logout|refresh) {
          proxy_pass http://matrix-authentication-service:8080;
          proxy_set_header X-Forwarded-For $remote_addr;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Host $host;
          
          # MAS requires HTTP 1.1
          proxy_http_version 1.1;
      }

      location ~ ^(/_matrix|/_synapse/client|/_synapse/mas) {
          # note: do not add a path (even a single /) after the port in `proxy_pass`,
          # otherwise nginx will canonicalise the URI and cause signature verification
          # errors.
          proxy_pass http://synapse:8008;
          proxy_set_header X-Forwarded-For $remote_addr;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Host $host:$server_port;

          # Nginx by default only allows file uploads up to 1M in size
          # Increase client_max_body_size to match max_upload_size defined in homeserver.yaml
          client_max_body_size 50M;
      
          # Synapse responses may be chunked, which is an HTTP/1.1 feature.
          proxy_http_version 1.1;
      }

      location / {
          proxy_pass http://matrix-authentication-service:8080;
          proxy_set_header X-Forwarded-For $remote_addr;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Host $host;

          proxy_http_version 1.1;
      }
  }
}
